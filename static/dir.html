<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="/static/css/dir.css">
		<link rel="stylesheet" type="text/css" href="/static/css/style.css">
	</head>
	<body>
		<div class = 'title'></div>
		<div class = 'buttons'>
			<div class = 'button'>make new file</div>
		</div>
		<div class = 'cols'>
		</div>
		<div id = 'newFile'>
			<div class='header'>Make a new file</div>
			<div>
				<span class = 'nomono'> Make a file named:</span> <input id = 'fileToMake' placeholder='untitled.js' type = 'text'/> <div class = 'button' style = 'display:inline-block;float:none;'>Go</div> <div class = 'button' id = 'toggleTemplates' style = 'display:inline-block;float:none;'>Show templates</div>
			</div>
			<br>
			<div id = 'templates'>
				<hr>
				<div> <span>Load from: </span><input type = 'text' id = 'templateDir' placeholder='/logan/templates/' value='/logan/templates/'/><div class = 'button' style = 'margin-left:18px;display:inline-block;float:none;'>Load</div></div>
				<br>
				<div id = 'files'></div>
			</div>

		</div>
		<script type='text/javascript' src='/static/js/jquery.js'></script>
		<script type='text/javascript' src='/static/js/helpers.js'></script>
		<script type='text/javascript'>
			jQuery.fn.highlight = function () {
				$(this).each(function () {
					var el = $(this);
					$("<div/>")
					.width(el.outerWidth())
					.height(el.outerHeight())
					.css({
						"position": "absolute",
						"left": el.offset().left,
						"top": el.offset().top,
						"background-color": "#2ecc71",
						"opacity": ".7",
						"z-index": "9999999"
					}).appendTo('body').fadeOut(1000).queue(function () { $(this).remove(); });
				});
			}

			$('#newFile').hide();
			$('#toggleTemplates').click(toggleTemplates);
			var dirs = ["button3.html","competition/","customize.html","dangerous/","dynamic.html","first.html","ftc.html","idonotknow.html","inputs.html","packedbombs.html","randomlinks.html","scamtest.html","sorryanothertest.css","test1/","thisisanothertest/","thisisatestofekdabbler.html","undefined","viralprize.html","worlddomination.html"];

			setUpUI();
			$(window).on('resize', function() {
				loadDirs(dirs);
			});

			function setUpUI() {
				$('.title').html(join('codezoo/',window.location.pathname));
				setTimeout(function(){loadDirs(dirs)}, 1);
			}

			function loadDirs(dirList, target, colWidthCutoff) { //
				var notNewFile = !target;

				if (!target) {
					target = $(".cols");
				}

				if (!colWidthCutoff) {
					colWidthCutoff = 300;
				}

				var dirs = [];
				var files = [];

				for (var i in dirList) {
					var t = dirList[i];
					if (t.charAt(t.length - 1) == '/') {
						dirs.push(t);
					} else {
						files.push(t);
					}
				}

				dirs = dirs.sort(function(a,b){
					if (a < b) return -1;
					if (a > b) return 1;
					return 0;
				});

				files = files.sort(function(a,b){
					if (a < b) return -1;
					if (a > b) return 1;
					return 0;
				});

				var numCols = Math.floor(target.width() / colWidthCutoff) || 1;

				target.empty();
				var dirsPerCol = Math.ceil(dirList.length/numCols 	);
				var colWidth = ((1/numCols) * 100);
				var cols = [];
				var colWidthCSS = 'calc(' + colWidth + '% - 20px)';
				for (var i = 0; i < numCols; i++) {
					var col = $('<div>', {class:'col'});
					col.css('margin-left', i * colWidth + '%');
					col.css('width',colWidthCSS);
					col.css('z-index', i + 1);
					target.append(col);
					cols.push(col);
				}

				dirs = dirs.concat(files);

				for (var i = 0; i < dirs.length; i++) {
					var subPath = dirs[i];
					var colNum = Math.floor(i/dirsPerCol);
					var item = $('<div>', {class:'item'});
					var itemName = $("<span>", {class:'itemName', text:subPath, title:"View " + join(window.location.pathname, subPath)});
					item.append(itemName);
					// var auxClass = colNum == numCols - 1 ? 'auxText' : 'auxText bordered';
					var auxText = $('<span>', {class:'', html:'&nbsp;'});
					if (subPath.charAt(subPath.length - 1) != '/' && notNewFile) {
						var editText = $('<a>', {class:'editText', text:'edit', href:join('/edit/', window.location.pathname.substr('/view/'.length), subPath), title:"Edit " + join(window.location.pathname, subPath)});

						auxText.append(editText);
					}

					item.append(auxText);
					makeFileCallback(location, subPath, notNewFile, item);
					cols[colNum].append(item);
					if (item[0].offsetWidth < item[0].scrollWidth) {
						auxText.attr('class','auxText');
					}
				}
			}

			function makeFileCallback(location, subPath, notNewFile, item) {
				if (notNewFile) {
					item.click(function(){
						window.location = join(window.location.pathname, subPath);
					});
				} else {
					item.click(function(){
						var prevVal = $('#fileToMake').val();
						debugger;
						q = prevVal.lastIndexOf('/');
						prevVal = prevVal.substr(0, q);
						$('#fileToMake').val(prevVal + (prevVal != '' && prevVal.charAt(prevVal.length - 1) != '/' ? '/' : '')+ subPath);
						$('#fileToMake').highlight();
					});
				}
			}

			(function showNewfile() {
				$('#newFile').show();
				loadDirs(["button3.html","customize.html","dynamic.html","first.html","ftc.html","idonotknow.html","inputs.html","packedbombs.html","randomlinks.html","scamtest.html","sorryanothertest.css","thisisatestofekdabbler.html","undefined","viralprize.html","worlddomination.html"], $('#files'))
			})();

			function toggleTemplates() {
				var templates = $("#templates");
				var toggleTemplates = $("#toggleTemplates");
				if (templates.is(':visible')) {
					toggleTemplates.html('Hide templates');
				} else {
					toggleTemplates.html('Show templates');
				}

				templates.toggle();
			}
		</script>
	</body>
</html>
